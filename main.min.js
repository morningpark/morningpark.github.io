var AssetAdapter=function(){function e(){}var a=(__define,e),t=a.prototype;return t.getAsset=function(e,a,t){function i(i){a.call(t,i,e)}if(RES.hasRes(e)){var n=RES.getRes(e);n?i(n):RES.getResAsync(e,i,this)}else RES.getResByUrl(e,i,this,RES.ResourceItem.TYPE_IMAGE)},e}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var BaseElement=function(){function e(){this.type="",this.typeID=0}var a=(__define,e);a.prototype;return e}();egret.registerClass(BaseElement,"BaseElement");var EnemyElement=function(e){function a(){e.apply(this,arguments),this.id=0,this.location=0,this.is=!1,this.special=0,this.isRow=!0}__extends(a,e);var t=(__define,a);t.prototype;return a}(BaseElement);egret.registerClass(EnemyElement,"EnemyElement");var GameElement=function(e){function a(){e.apply(this,arguments),this.id=0,this.location=0,this.is=!1,this.special=0,this.isRow=!0}__extends(a,e);var t=(__define,a);t.prototype;return a}(BaseElement);egret.registerClass(GameElement,"GameElement");var LevelRequireElement=function(e){function a(){e.apply(this,arguments),this.num=0}__extends(a,e);var t=(__define,a);t.prototype;return a}(BaseElement);egret.registerClass(LevelRequireElement,"LevelRequireElement");var GameData=function(){function e(){}var a=(__define,e);a.prototype;return e.initData=function(){e.mapData=[];for(var a=0;a<e.MaxRow;a++){e.mapData[a]=[];for(var t=0;t<e.MaxColumn;t++)e.mapData[a].push(-2)}e.levelreq=new LevelRequire,e.elements=[],e.enemys=[],e.unusedElements=[];for(var i=e.MaxRow*e.MaxColumn,n=0;i>n;n++){var s=new GameElement;s.id=n;var m=new EnemyElement;e.elements.push(s),e.enemys.push(m),e.enemys[n].type="-1",e.unusedElements.push(n)}e.stageH=egret.MainContext.instance.stage.stageHeight,e.stageW=egret.MainContext.instance.stage.stageWidth},e.unmapnum=0,e.gameScore=0,e.gameLife=0,e.levelBackgroundImageName="",e.MaxRow=9,e.MaxColumn=9,e.currentElementNum=0,e.stageW=0,e.stageH=0,e}();egret.registerClass(GameData,"GameData");var LevelGameDataParse=function(){function e(){}var a=(__define,e);a.prototype;return e.parseLevelGameData=function(e){GameData.elementTypes=e.element,GameData.levelBackgroundImageName=e.levelbgimg},e}();egret.registerClass(LevelGameDataParse,"LevelGameDataParse");var LevelRequire=function(){function e(){this.reqElements=[]}var a=(__define,e),t=a.prototype;return t.getLevelReqNum=function(){return this.reqElements.length},t.addElement=function(e,a){var t=new LevelRequireElement;t.num=a,t.type=e,this.reqElements.push(t)},t.openChange=function(){this.reqElements=[]},t.changeReqNum=function(e,a){for(var t=this.getLevelReqNum(),i=0;t>i;i++)if(this.reqElements[i].type=e)return void(this.reqElements[i].num-=a)},t.isClear=function(){for(var e=this.getLevelReqNum(),a=0;e>a;a++)if(this.reqElements[a].num>0)return!1;return!0},e}();egret.registerClass(LevelRequire,"LevelRequire");var LinkLogic=function(){function e(){}var a=(__define,e);a.prototype;return e.isHaveLine=function(){e.lines=[];for(var a="",t=0,i=0;i<GameData.MaxRow;i++){for(var n=0;n<GameData.MaxColumn;n++){var s=i*GameData.MaxColumn+n;if(-1!=GameData.mapData[i][n]||-1==GameData.mapData[i][n]&&""!=GameData.enemys[s].type&&"9"!=GameData.enemys[s].type)if(-1!=GameData.mapData[i][n]&&a==GameData.elements[GameData.mapData[i][n]].type||a==GameData.enemys[s].type)t++;else{if(t>=3){for(var m=[],r=0;t>r;r++)m.push(GameData.mapData[i][n-r-1]);e.lines.push(m)}a=-1!=GameData.mapData[i][n]?GameData.elements[GameData.mapData[i][n]].type:GameData.enemys[s].type,t=1}else{if(t>=3){var m=[];for(r=0;t>r;r++)m.push(GameData.mapData[i][n-r-1]);e.lines.push(m)}a="",t=0}}if(t>=3){for(var m=[],r=0;t>r;r++)m.push(GameData.mapData[i][n-r-1]);e.lines.push(m)}a="",t=0}for(i=0;i<GameData.MaxRow;i++){for(var n=0;n<GameData.MaxColumn;n++){var s=n*GameData.MaxColumn+i;if(-1!=GameData.mapData[n][i]||-1==GameData.mapData[n][i]&&""!=GameData.enemys[s].type&&"9"!=GameData.enemys[s].type)if(-1!=GameData.mapData[n][i]&&a==GameData.elements[GameData.mapData[n][i]].type||a==GameData.enemys[s].type)t++;else{if(t>=3){for(var m=[],r=0;t>r;r++)m.push(GameData.mapData[n-r-1][i]);e.lines.push(m)}a=-1!=GameData.mapData[n][i]?GameData.elements[GameData.mapData[n][i]].type:GameData.enemys[s].type,t=1}else{if(t>=3){for(var m=[],r=0;t>r;r++)m.push(GameData.mapData[n-r-1][i]);e.lines.push(m)}a="",t=0}}if(t>=3){for(var m=[],r=0;t>r;r++)m.push(GameData.mapData[n-r-1][i]);e.lines.push(m)}a="",t=0}for(var o=e.lines.length,i=0;o>i;i++)for(var h=e.lines[i].length,n=0;h>n;n++)if(-1!=e.lines[i][n]&&0!=GameData.elements[e.lines[i][n]].special){var l=(GameLogic.instance.evm.elementviews[GameData.elements[e.lines[i][n]].id].id,Math.floor(GameLogic.instance.evm.elementviews[GameData.elements[e.lines[i][n]].id].location/GameData.MaxColumn)),c=GameLogic.instance.evm.elementviews[GameData.elements[e.lines[i][n]].id].location%GameData.MaxColumn,p=GameData.elements[GameData.mapData[l][c]];switch(GameData.elements[e.lines[i][n]].special){case 1:PropLogic.row(p.location),p.special=0;break;case 2:PropLogic.column(p.location),p.special=0;break;case 3:PropLogic.bomb(p.location),p.special=0;break;case 4:PropLogic.color(p.location),p.special=0}}return 0!=e.lines.length?!0:!1},e.isNextHaveLine=function(){for(var e=0;e<GameData.MaxRow;e++)for(var a=0;a<GameData.MaxColumn;a++)if(-1!=GameData.mapData[e][a]){if(a<GameData.MaxColumn-1&&-1!=GameData.mapData[e][a+1]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e][a+1]].type){if(a>0&&-1!=GameData.mapData[e][a-1]){if(e>0&&GameData.mapData[e-1][a-1]&&-1!=GameData.mapData[e-1][a-1]&&GameData.elements[GameData.mapData[e-1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(e<GameData.MaxRow-1&&GameData.mapData[e+1][a-1]&&-1!=GameData.mapData[e+1][a-1]&&GameData.elements[GameData.mapData[e+1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(a>1&&GameData.mapData[e][a-2]&&-1!=GameData.mapData[e][a-2]&&GameData.elements[GameData.mapData[e][a-2]].type==GameData.elements[GameData.mapData[e][a]].type)return!0}if(a<GameData.MaxColumn-2&&-1!=GameData.mapData[e][a+2]){if(e>0&&GameData.mapData[e-1][a+2]&&-1!=GameData.mapData[e-1][a+2]&&GameData.elements[GameData.mapData[e-1][a+2]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(e<GameData.MaxRow-1&&GameData.mapData[e+1][a+2]&&-1!=GameData.mapData[e+1][a+2]&&GameData.elements[GameData.mapData[e+1][a+2]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(a<GameData.MaxColumn-3&&GameData.mapData[e][a+3]&&-1!=GameData.mapData[e][a+3]&&GameData.elements[GameData.mapData[e][a+3]].type==GameData.elements[GameData.mapData[e][a]].type)return!0}}if(e<GameData.MaxRow-1&&-1!=GameData.mapData[e+1][a]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e+1][a]].type){if(e>0&&-1!=GameData.mapData[e-1][a]){if(a>0&&GameData.mapData[e-1][a-1]&&-1!=GameData.mapData[e-1][a-1]&&GameData.elements[GameData.mapData[e-1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(a<GameData.MaxColumn-1&&GameData.mapData[e-1][a+1]&&-1!=GameData.mapData[e-1][a+1]&&GameData.elements[GameData.mapData[e-1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(e>1&&GameData.mapData[e-2][a]&&-1!=GameData.mapData[e-2][a]&&GameData.elements[GameData.mapData[e-2][a]].type==GameData.elements[GameData.mapData[e][a]].type)return!0}if(e<GameData.MaxRow-2&&-1!=GameData.mapData[e+2][a]){if(a>0&&GameData.mapData[e+2][a-1]&&-1!=GameData.mapData[e+2][a-1]&&GameData.elements[GameData.mapData[e+2][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(a<GameData.MaxColumn-1&&GameData.mapData[e+2][a+1]&&-1!=GameData.mapData[e+2][a+1]&&GameData.elements[GameData.mapData[e+2][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(e<GameData.MaxRow-3&&GameData.mapData[e+3][a]&&-1!=GameData.mapData[e+3][a]&&GameData.elements[GameData.mapData[e+3][a]].type==GameData.elements[GameData.mapData[e][a]].type)return!0}}if(a<GameData.MaxColumn-2&&-1!=GameData.mapData[e][a+2]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e][a+2]].type&&-1!=GameData.mapData[e][a+1]){if(e>0&&GameData.mapData[e-1][a+1]&&-1!=GameData.mapData[e-1][a+1]&&GameData.elements[GameData.mapData[e-1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(e<GameData.MaxRow-1&&GameData.mapData[e+1][a+1]&&-1!=GameData.mapData[e+1][a+1]&&GameData.elements[GameData.mapData[e+1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0}if(e<GameData.MaxRow-2&&-1!=GameData.mapData[e+2][a]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e+2][a]].type&&-1!=GameData.mapData[e+1][a]){if(a>0&&GameData.mapData[e+1][a-1]&&-1!=GameData.mapData[e+1][a-1]&&GameData.elements[GameData.mapData[e+1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0;if(a<GameData.MaxColumn-1&&GameData.mapData[e+1][a+1]&&-1!=GameData.mapData[e+1][a+1]&&GameData.elements[GameData.mapData[e+1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return!0}}return!1},e.canMove=function(e,a){var t=Math.floor(GameData.elements[e].location/GameData.MaxColumn),i=GameData.elements[e].location%GameData.MaxColumn,n=Math.floor(GameData.elements[a].location/GameData.MaxColumn),s=GameData.elements[a].location%GameData.MaxColumn;return t==n&&1==Math.abs(i-s)?(GameData.elements[a].isRow=!0,GameData.elements[e].isRow=!0,!0):i==s&&1==Math.abs(t-n)?(GameData.elements[a].isRow=!1,GameData.elements[e].isRow=!1,!0):!1},e.chageOrder=function(){for(var e=[],a=0;a<GameData.MaxRow;a++)for(var t=0;t<GameData.MaxColumn;t++)-1!=GameData.mapData[a][t]&&(5!=GameData.elements[GameData.mapData[a][t]].typeID?(e[GameData.elements[GameData.mapData[a][t]].typeID]||(e[GameData.elements[GameData.mapData[a][t]].typeID]=[]),e[GameData.elements[GameData.mapData[a][t]].typeID].push(GameData.mapData[a][t])):GameData.elementTypes.length<5&&(e[GameData.elementTypes.length]||(e[GameData.elementTypes.length]=[]),e[GameData.elementTypes.length].push(GameData.mapData[a][t])));for(var i="",n=!0,s="",m="",r=0,o=0,h=0,a=0;a<GameData.MaxRow;a++)for(var t=0;t<GameData.MaxColumn;t++)if(-1!=GameData.mapData[a][t]){for(;n;)o=0==h&&e.length>1&&e[0].length==e[1].length?RandomUtils.limit(0,1):h,console.log(o+":"+e.length+":"+(a*GameData.MaxColumn+t)),o>e.length-1?(o=e.length-1,r=RandomUtils.limit(0,e[o].length-1),GameData.elements[e[o][r]].type=GameData.elementTypes[Math.floor(Math.random()*GameData.elementTypes.length)].toString()):r=RandomUtils.limit(0,e[o].length-1),i=GameData.elements[e[o][r]].type,a>1&&-1!=GameData.mapData[a-1][t]&&-1!=GameData.mapData[a-2][t]&&GameData.elements[GameData.mapData[a-1][t]].type==GameData.elements[GameData.mapData[a-2][t]].type&&(s=GameData.elements[GameData.mapData[a-1][t]].type),t>1&&-1!=GameData.mapData[a][t-1]&&-1!=GameData.mapData[a][t-2]&&GameData.elements[GameData.mapData[a][t-1]].type==GameData.elements[GameData.mapData[a][t-2]].type&&(m=GameData.elements[GameData.mapData[a][t-1]].type),i!=s&&i!=m?(n=!1,h=0):h++;GameData.mapData[a][t]=e[o][r],GameData.elements[e[o][r]].location=a*GameData.MaxColumn+t,e[o].splice(r,1),e[o].length<1&&e.splice(o,1),n=!0,e.sort(function(e,a){return a.length-e.length})}},e.isHaveLineByIndex=function(a,t){var i=GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow],n=GameData.mapData[Math.floor(t/GameData.MaxColumn)][t%GameData.MaxRow];GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow]=n,GameData.mapData[Math.floor(t/GameData.MaxColumn)][t%GameData.MaxRow]=i;var s;if(4==GameData.elements[i].special){PropLogic.color(a);var m=[];m.push(GameData.mapData[Math.floor(t/GameData.MaxColumn)][t%GameData.MaxRow]),e.lines.push(m),GameData.elements[i].special=0,s=!0}else if(4==GameData.elements[n].special){PropLogic.color(t);var m=[];m.push(GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow]),e.lines.push(m),GameData.elements[i].special=0,s=!0}else s=e.isHaveLine();return s?(GameData.elements[i].location=t,GameData.elements[n].location=a,!0):(GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow]=i,GameData.mapData[Math.floor(t/GameData.MaxColumn)][t%GameData.MaxRow]=n,!1)},e}();egret.registerClass(LinkLogic,"LinkLogic");var MapControl=function(){function e(){}var a=(__define,e),t=a.prototype;return t.createElementAllMap=function(){this.createAllMap()},t.createElements=function(e){for(var a=[],t=0;e>t;t++)a.push(this.createType().toString());return a},t.changeTypeByID=function(e){var a=this.createType();GameData.elements[e].typeID=a,GameData.elements[e].type=a.toString()},t.updateMapLovation=function(){for(var e=[],a=LinkLogic.lines.length,t=0;a>t;t++)for(var i=LinkLogic.lines[t].length,n=0;i>n;n++)if(-1!=LinkLogic.lines[t][n]){4==LinkLogic.lines[t].length&&GameData.elements[LinkLogic.lines[t][n]].is&&(GameData.elements[LinkLogic.lines[t][n]].isRow?GameData.elements[LinkLogic.lines[t][n]].special=1:GameData.elements[LinkLogic.lines[t][n]].special=2),5==LinkLogic.lines[t].length&&GameData.elements[LinkLogic.lines[t][n]].is&&(GameData.elements[LinkLogic.lines[t][n]].special=4,GameData.elements[LinkLogic.lines[t][n]].type="5",GameData.elements[LinkLogic.lines[t][n]].typeID=5);for(var s=!1,m=e.length,r=0;m>r;r++)e[r]==LinkLogic.lines[t][n]&&(s=!0,3==LinkLogic.lines[t].length&&(GameData.elements[e[r]].special=3));s||e.push(LinkLogic.lines[t][n])}a=e.length;var o=[];for(t=0;a>t;t++){for(0==GameData.elements[e[t]].special&&this.changeTypeByID(e[t]),s=!1,n=0;n<o.length;n++)o[n]==GameData.elements[e[t]].location%GameData.MaxColumn&&(s=!0);s||o.push(GameData.elements[e[t]].location%GameData.MaxColumn)}for(a=o.length,t=0;a>t;t++){var h=[],l=[];for(n=GameData.MaxRow-1;n>=0;n--){s=!1;for(var c=0;c<e.length;c++)GameData.mapData[n][o[t]]==e[c]&&0==GameData.elements[e[c]].special&&(l.push(e[c]),s=!0);s||-1!=GameData.mapData[n][o[t]]&&h.push(GameData.mapData[n][o[t]])}for(h=h.concat(l),n=GameData.MaxRow-1;n>=0;n--)-1!=GameData.mapData[n][o[t]]&&(GameData.mapData[n][o[t]]=h[0],GameData.elements[h[0]].location=n*GameData.MaxRow+o[t],h.shift())}},t.createAllMap=function(){for(var e=(GameData.MaxRow*GameData.MaxColumn,""),a=!0,t=0,i="",n="",s=0,m=0;m<GameData.MaxRow;m++)for(var r=0;r<GameData.MaxColumn;r++)if(-1!=GameData.mapData[m][r]){for(;a;)s=this.createType(),e=s.toString(),m>1&&-1!=GameData.mapData[m-1][r]&&-1!=GameData.mapData[m-2][r]&&GameData.elements[GameData.mapData[m-1][r]].type==GameData.elements[GameData.mapData[m-2][r]].type&&(i=GameData.elements[GameData.mapData[m-1][r]].type),r>1&&-1!=GameData.mapData[m][r-1]&&-1!=GameData.mapData[m][r-2]&&GameData.elements[GameData.mapData[m][r-1]].type==GameData.elements[GameData.mapData[m][r-2]].type&&(n=GameData.elements[GameData.mapData[m][r-1]].type),e!=i&&e!=n&&(a=!1);t=GameData.unusedElements[0],GameData.elements[t].typeID=s,GameData.elements[t].type=e,GameData.elements[t].location=m*GameData.MaxRow+r,GameData.mapData[m][r]=t,GameData.unusedElements.shift(),a=!0,i="",n=""}},t.createType=function(){return GameData.elementTypes[Math.floor(Math.random()*GameData.elementTypes.length)]},e}();egret.registerClass(MapControl,"MapControl");var MapDataPares=function(){function e(){}var a=(__define,e);a.prototype;return e.createMapData=function(e){var a=e.length;GameData.unmapnum=a;for(var t=0,i=0;a>i;i++){t=e[i];var n=Math.floor(t/GameData.MaxColumn),s=t%GameData.MaxColumn;GameData.mapData[n][s]=-1,GameData.enemys[t].type=""}GameData.currentElementNum=GameData.MaxRow*GameData.MaxColumn-a},e}();egret.registerClass(MapDataPares,"MapDataPares");var PropLogic=function(){function e(){}var a=(__define,e);a.prototype;return e.useProp=function(a,t){switch(a){case 0:e.tap(t);break;case 1:e.change(t);break;case 2:break;case 3:break;case 4:}},e.change=function(e){GameData.elements[GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxColumn]].special=RandomUtils.limit(1,3),GameLogic.instance.evm.updateMapData()},e.color=function(e){for(var a=[],t=GameData.elements[GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxColumn]].type,i=0;i<GameData.MaxRow;i++)for(var n=0;n<GameData.MaxColumn;n++)-1!=GameData.mapData[i][n]&&GameData.elements[GameData.mapData[i][n]].type==t&&(a.push(GameData.mapData[i][n]),LinkLogic.lines.push(a),a=[])},e.bomb=function(e){var a=[],t=Math.floor(e/GameData.MaxColumn),i=e%GameData.MaxColumn;a.push(GameData.elements[GameData.mapData[t][i]].id),LinkLogic.lines.push(a),a=[],t>0&&-1!=GameData.mapData[t-1][i]&&(a.push(GameData.mapData[t-1][i]),LinkLogic.lines.push(a),a=[],t>1&&-1!=GameData.mapData[t-2][i]&&(a.push(GameData.mapData[t-2][i]),LinkLogic.lines.push(a),a=[]),i>0&&-1!=GameData.mapData[t-1][i-1]&&(a.push(GameData.mapData[t-1][i-1]),LinkLogic.lines.push(a),a=[]),i<GameData.MaxColumn-1&&-1!=GameData.mapData[t-1][i+1]&&(a.push(GameData.mapData[t-1][i+1]),LinkLogic.lines.push(a),a=[])),t<GameData.MaxRow-1&&-1!=GameData.mapData[t+1][i]&&(a.push(GameData.mapData[t+1][i]),LinkLogic.lines.push(a),a=[],t<GameData.MaxRow-2&&-1!=GameData.mapData[t+2][i]&&(a.push(GameData.mapData[t+2][i]),LinkLogic.lines.push(a),a=[]),i>0&&-1!=GameData.mapData[t+1][i-1]&&(a.push(GameData.mapData[t+1][i-1]),LinkLogic.lines.push(a),a=[]),i<GameData.MaxColumn-1&&-1!=GameData.mapData[t+1][i+1]&&(a.push(GameData.mapData[t+1][i+1]),LinkLogic.lines.push(a),a=[])),i>0&&-1!=GameData.mapData[t][i-1]&&(a.push(GameData.mapData[t][i-1]),LinkLogic.lines.push(a),a=[],i>1&&-1!=GameData.mapData[t][i-2]&&(a.push(GameData.mapData[t][i-2]),LinkLogic.lines.push(a),a=[])),i<GameData.MaxColumn-1&&-1!=GameData.mapData[t][i+1]&&(a.push(GameData.mapData[t][i+1]),LinkLogic.lines.push(a),a=[],i<GameData.MaxColumn-2&&-1!=GameData.mapData[t][i+2]&&(a.push(GameData.mapData[t][i+2]),LinkLogic.lines.push(a),a=[]))},e.row=function(e){for(var a=[],t=Math.floor(e/GameData.MaxColumn),i=0;i<GameData.MaxRow;i++)-1!=GameData.mapData[t][i]&&(a.push(GameData.mapData[t][i]),LinkLogic.lines.push(a),a=[])},e.column=function(e){for(var a=[],t=e%GameData.MaxColumn,i=0;i<GameData.MaxColumn;i++)-1!=GameData.mapData[i][t]&&(a.push(GameData.mapData[i][t]),LinkLogic.lines.push(a),a=[])},e.tap=function(e){var a=[],t=Math.floor(e/GameData.MaxColumn),i=e%GameData.MaxColumn;a.push(GameData.elements[GameData.mapData[t][i]].id),LinkLogic.lines.push(a)},e}();egret.registerClass(PropLogic,"PropLogic");var ElementViewManageEvent=function(e){function a(a,t,i){void 0===t&&(t=!1),void 0===i&&(i=!1),e.call(this,a,t,i),this.propToElementLocation=0,this.ele1=0,this.ele2=0}__extends(a,e);var t=(__define,a);t.prototype;return a.TAP_TWO_ELEMENT="tap_two_element",a.REMOVE_ANIMATION_OVER="remove_animation_over",a.UPDATE_MAP="update_map",a.UPDATE_VIEW_OVER="update_view_over",a.USE_PROP_CLICK="use_prop_click",a}(egret.Event);egret.registerClass(ElementViewManageEvent,"ElementViewManageEvent");var LoadingUI=function(e){function a(){e.call(this),this.createView()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center",this.textField.textColor=0},i.setProgress=function(e,a){this.textField.text="Loading..."+e+"/"+a},a}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function a(){e.apply(this,arguments),this.isThemeLoadEnd=!1,this.isResourceLoadEnd=!1}__extends(a,e);var t=(__define,a),i=t.prototype;return i.createChildren=function(){e.prototype.createChildren.call(this);var a=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",a),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},i.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var a=new eui.Theme("resource/default.thm.json",this.stage);a.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},i.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},i.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},i.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},i.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},i.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},i.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},i.startCreateScene=function(){var e=new egret.Sprite;this.addChild(e),this._gl=new GameLogic(e)},a}(eui.UILayer);egret.registerClass(Main,"Main");var ThemeAdapter=function(){function e(){}var a=(__define,e),t=a.prototype;return t.getTheme=function(e,a,t,i){function n(e){a.call(i,e)}function s(a){a.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),t.call(i))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),RES.getResByUrl(e,n,this,RES.ResourceItem.TYPE_TEXT)},e}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);var end=function(e){function a(){e.call(this)}__extends(a,e);var t=(__define,a),i=t.prototype;return i.partAdded=function(a,t){e.prototype.partAdded.call(this,a,t)},i.childrenCreated=function(){e.prototype.childrenCreated.call(this)},a}(eui.Component);egret.registerClass(end,"end",["eui.UIComponent"]);var game=function(e){function a(){e.call(this),this.life=new life,this.init()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.partAdded=function(a,t){e.prototype.partAdded.call(this,a,t)},i.childrenCreated=function(){e.prototype.childrenCreated.call(this)},i.init=function(){this.skinName="resource/eui_skins/game.exml",this.scroe.text="0",this.update(),this.life.x=324,this.life.y=122,this.addChild(this.life)},i.update=function(){this.scroe.text=GameData.gameScore.toString()},i.lifeChange=function(){this.life.update()},a}(eui.Component);egret.registerClass(game,"game",["eui.UIComponent"]);var life=function(e){function a(){e.call(this),this.life=[],this.init()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.partAdded=function(a,t){e.prototype.partAdded.call(this,a,t)},i.childrenCreated=function(){e.prototype.childrenCreated.call(this)},i.init=function(){for(var e,a,t=GameData.gameLife,i=90/t,n=t;n>0;n--)e=new egret.Bitmap,e.texture=RES.getRes("life_black_png"),e.width=e.height=i,this.addChild(e),e.anchorOffsetY=e.height/2,e.y=15,e.x=138-n*i-30*n/t,a=new egret.Bitmap,a.texture=RES.getRes("life_white_png"),a.width=a.height=i,this.addChild(a),a.anchorOffsetY=a.height/2,a.y=15,a.x=138-n*i-30*n/t,this.life.unshift(e)},i.update=function(){this.life.length;this.removeChild(this.life[0]),this.life.shift()},a}(eui.Component);egret.registerClass(life,"life",["eui.UIComponent"]);var startUI=function(e){function a(){e.call(this),this.init()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.partAdded=function(a,t){e.prototype.partAdded.call(this,a,t)},i.childrenCreated=function(){e.prototype.childrenCreated.call(this)},i.init=function(){this.skinName="resource/eui_skins/startUI.exml",this.start.addEventListener(egret.TouchEvent.TOUCH_TAP,this.startGame,this),this.startText.addEventListener(egret.TouchEvent.TOUCH_TAP,this.startGame,this),this.tips.addEventListener(egret.TouchEvent.TOUCH_TAP,this.showTips,this),this.tipsText.addEventListener(egret.TouchEvent.TOUCH_TAP,this.showTips,this)},i.startGame=function(){SoundManager.playEffect("Clock Tick_wav"),GameLogic.instance.init(),this.parent.removeChild(this)},i.showTips=function(){SoundManager.playEffect("Clock Tick_wav")},a}(eui.Component);egret.registerClass(startUI,"startUI",["eui.UIComponent"]);var RandomUtils=function(){function e(){}var a=(__define,e);a.prototype;return e.limit=function(e,a){e=Math.min(e,a),a=Math.max(e,a);var t=a-e+1;return Math.floor(e+Math.random()*t)},e.limitInteger=function(e,a){return Math.round(this.limit(e,a))},e.randomArray=function(e){var a=Math.floor(Math.random()*e.length);return e[a]},e}();egret.registerClass(RandomUtils,"RandomUtils");var SoundManager=function(){function e(){}var a=(__define,e);a.prototype;return e.playEffect=function(e,a){void 0===a&&(a=1);var t=RES.getRes(e);t.type=egret.Sound.EFFECT;var i=t.play(0,1);i.volume=a},e.playBgSound=function(e,a){void 0===a&&(a=!0),this.sdbg=RES.getRes(e),this.sdbg.type=egret.Sound.MUSIC,this.channelBG=this.sdbg.play(0,0),this.channelBG.volume=.3},e.stopBgSound=function(){this.channelBG.stop()},e}();egret.registerClass(SoundManager,"SoundManager");var ElementView=function(e){function a(a){e.call(this),this.is=!1,this.special=0,this.location=0,this._id=-1,this._focus=!1,this.speed=600,this.thisparent=a,this.init()}__extends(a,e);var t=__define,i=a,n=i.prototype;return t(n,"id",function(){return this._id},function(e){this._id=e}),n.init=function(){this.touchEnabled=!0,this.touchChildren=!1,this.bitmap=new egret.Bitmap;var e=(GameData.stageW-40)/GameData.MaxColumn;this.bitmap.width=this.bitmap.height=e,this.bitmap.x=-1*e/2,this.bitmap.y=-1*e/2,this.addChild(this.bitmap)},n.setTexture=function(e){this.bitmap.texture=RES.getRes(e)},t(n,"focus",function(){return this._focus}),n.setFocus=function(e){if(e!=this._focus){if(this._focus=e,!this._focusMc){var a=RES.getRes(""),t=RES.getRes(""),i=new egret.MovieClipDataFactory(t,a);this._focusMc=new egret.MovieClip(i.generateMovieClipData("")),this._focusMc.x=this._focusMc.width/-2,this._focusMc.y=this._focusMc.height/-2}e?(this.addChild(this._focusMc),this._focusMc.play(-1)):this._focusMc.parent&&(this._focusMc.stop(),this.removeChild(this._focusMc))}},n.move=function(){var e=egret.Tween.get(this);e.to({x:this.targetX(),y:this.targetY()},this.speed,egret.Ease.cubicInOut)},n.show=function(e){var a=egret.Tween.get(this);a.wait(e,!1),a.call(this.addThisToParent,this),a.to({x:this.targetX(),y:this.targetY()},this.speed,egret.Ease.bounceInOut)},n.addThisToParent=function(){this.parent||this.thisparent.addChild(this)},n.targetX=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=8+e*(this.location%GameData.MaxColumn)+e/2+5+2*(this.location%GameData.MaxColumn);return a},n.targetY=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=GameData.stageH-(GameData.stageW-30)/6-60-e*GameData.MaxColumn-5,t=a+e*Math.floor(this.location/GameData.MaxColumn)+e/2+5+2*Math.floor(this.location/GameData.MaxColumn);return t},n.moveAndBack=function(e,a){void 0===a&&(a=!1);var t=(GameData.stageW-40)/GameData.MaxColumn,i=8+t*(e%GameData.MaxColumn)+t/2+5+2*(e%GameData.MaxColumn),n=GameData.stageH-(GameData.stageW-30)/6-60-t*GameData.MaxColumn-5,s=n+t*Math.floor(e/GameData.MaxColumn)+t/2+5+2*Math.floor(e/GameData.MaxColumn),m=egret.Tween.get(this);a?m.to({x:i,y:s,scaleX:1.2,scaleY:1.2},300,egret.Ease.cubicInOut).call(this.back,this):m.to({x:i,y:s,scaleX:.8,scaleY:.8},300,egret.Ease.cubicInOut).call(this.back,this)},n.back=function(){var e=egret.Tween.get(this);e.to({x:this.targetX(),y:this.targetY(),scaleX:1,scaleY:1},300,egret.Ease.cubicInOut)},n.moveAndScale=function(e,a){void 0===a&&(a=!1);var t=(GameData.stageW-40)/GameData.MaxColumn,i=8+t*(e%GameData.MaxColumn)+t/2+5+2*(e%GameData.MaxColumn),n=GameData.stageH-(GameData.stageW-30)/6-60-t*GameData.MaxColumn-5,s=n+t*Math.floor(e/GameData.MaxColumn)+t/2+5+2*Math.floor(e/GameData.MaxColumn);this.location=e;var m=egret.Tween.get(this);a?m.to({x:i,y:s,scaleX:1.4,scaleY:1.4},300,egret.Ease.cubicInOut).call(this.backScale,this):m.to({x:i,y:s,scaleX:.6,scaleY:.6},300,egret.Ease.cubicInOut).call(this.backScale,this)},n.backScale=function(){var e=egret.Tween.get(this);e.to({scaleX:1,scaleY:1},300,egret.Ease.backOut).call(this.canRemove,this)},n.canRemove=function(){var e=new ElementViewManageEvent(ElementViewManageEvent.REMOVE_ANIMATION_OVER);this.dispatchEvent(e)},n.playCurveMove=function(e,a){var t=egret.Tween.get(this);t.to({x:e,y:a},700,egret.Ease.quadOut).call(this.overCurveMove,this)},n.playSpecial=function(){var e=egret.Tween.get(this);switch(this.special){case 1:e.to({scaleX:1.1},150,egret.Ease.backOut).to({scaleX:.9},150,egret.Ease.backOut).to({scaleX:1.1},150,egret.Ease.backOut).to({scaleX:.9},150,egret.Ease.backOut).to({scaleX:1.2},50,egret.Ease.backOut);break;case 2:e.to({scaleY:1.1},150,egret.Ease.backOut).to({scaleY:.9},150,egret.Ease.backOut).to({scaleY:1.1},150,egret.Ease.backOut).to({scaleY:.9},150,egret.Ease.backOut).to({scaleY:1.2},50,egret.Ease.backOut);break;case 3:e.to({rotation:10},100,egret.Ease.backOut).to({rotation:0},100,egret.Ease.backOut).to({rotation:10},100,egret.Ease.backOut).to({rotation:0},100,egret.Ease.backOut).to({scaleX:1.2,scaleY:1.2},350,egret.Ease.backOut).to({scaleX:1,scaleY:1},200,egret.Ease.backOut);break;case 4:e.to({rotation:10},100,egret.Ease.backOut).to({rotation:-10},100,egret.Ease.backOut).to({rotation:10},100,egret.Ease.backOut).to({rotation:-10},100,egret.Ease.backOut).to({rotation:0},50,egret.Ease.backOut)}},n.overCurveMove=function(){this.parent&&this.parent.removeChild(this);var e=new ElementViewManageEvent(ElementViewManageEvent.REMOVE_ANIMATION_OVER);this.dispatchEvent(e)},n.playRemoveAni=function(){0!=this.special?GameLogic.instance.energyNum+=5:GameLogic.instance.energyNum+=2,GameLogic.instance.pvm.checkRandomProp(),this.special=0;var e=egret.Tween.get(this);e.to({scaleX:1.3,scaleY:1.3},200,egret.Ease.cubicInOut).to({scaleX:1.4,scaleY:1.4},100,egret.Ease.cubicInOut).call(this.removeAnicall,this);for(var a=Math.floor(this.location/GameData.MaxColumn),t=this.location%GameData.MaxColumn,i=0;i<GameLogic.instance.em.enemyviews.length;i++)GameLogic.instance.em.enemyviews[i].hp>0&&(this.location%GameData.MaxColumn!=8&&GameLogic.instance.em.enemyviews[i].location==this.location+1&&(GameData.elements[GameData.mapData[a][t]].type!=GameLogic.instance.em.enemyviews[i].type?GameLogic.instance.em.enemyviews[i].injured():(GameLogic.instance.em.enemyviews[i].hp++,GameLogic.instance.em.enemyviews[i].hpShow(GameLogic.instance.em.enemyviews[i].hp))),this.location%GameData.MaxColumn!=0&&GameLogic.instance.em.enemyviews[i].location==this.location-1&&(GameData.elements[GameData.mapData[a][t]].type!=GameLogic.instance.em.enemyviews[i].type?GameLogic.instance.em.enemyviews[i].injured():(GameLogic.instance.em.enemyviews[i].hp++,GameLogic.instance.em.enemyviews[i].hpShow(GameLogic.instance.em.enemyviews[i].hp))),(GameLogic.instance.em.enemyviews[i].location==this.location+GameData.MaxColumn||GameLogic.instance.em.enemyviews[i].location==this.location-GameData.MaxColumn)&&(GameData.elements[GameData.mapData[a][t]].type!=GameLogic.instance.em.enemyviews[i].type?GameLogic.instance.em.enemyviews[i].injured():(GameLogic.instance.em.enemyviews[i].hp++,GameLogic.instance.em.enemyviews[i].hpShow(GameLogic.instance.em.enemyviews[i].hp))))},n.removeAnicall=function(){this.parent&&(this.parent.removeChild(this),this.is=!1);var e=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_MAP);this.dispatchEvent(e)},n.moveNewLocation=function(){if(LinkLogic.lines=[],!this.parent){var e=(GameData.stageW-40)/GameData.MaxColumn,a=GameData.stageH-(GameData.stageW-30)/6-60-e*GameData.MaxColumn;
0==this.special&&(this.y=a-this.width),this.scaleX=1,this.scaleY=1,this.x=this.targetX(),this.thisparent.addChild(this)}egret.Tween.get(this).to({x:this.targetX(),y:this.targetY(),scaleX:1,scaleY:1},300,egret.Ease.bounceInOut).call(this.moveNewLocationOver,this)},n.moveNewLocationOver=function(){var e=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_VIEW_OVER);this.dispatchEvent(e)},a}(egret.Sprite);egret.registerClass(ElementView,"ElementView");var ElementViewManage=function(e){function a(a){e.call(this),this.canTouch=!0,this._currentTapID=-1,this._currentMoveID=-1,this.removenum=0,this.moveeleNum=0,this.movelocElementNum=0,this._layer=a,this.init()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.init=function(){this.elementviews=new Array;for(var e,a=GameData.MaxColumn*GameData.MaxRow,t=0;a>t;t++)e=new ElementView(this._layer),e.id=t,e.location=GameData.elements[t].location,this.elementviews.push(e),e.addEventListener(ElementViewManageEvent.REMOVE_ANIMATION_OVER,this.removeAniOver,this),e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.elTap,this),e.addEventListener(ElementViewManageEvent.UPDATE_MAP,this.updateMap,this),e.addEventListener(ElementViewManageEvent.UPDATE_VIEW_OVER,this.moveNewLocationOver,this),e.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.touchStart,this)},i.elTap=function(e){if(this.canTouch)if(-1==PropViewManage.proptype){if(e.currentTarget instanceof ElementView){var a=e.currentTarget;if(-1!=this._currentTapID)if(a.id==this._currentTapID)a.setFocus(!1),this._currentTapID=-1;else{var t=new ElementViewManageEvent(ElementViewManageEvent.TAP_TWO_ELEMENT);t.ele1=this._currentTapID,t.ele2=a.id,this.dispatchEvent(t)}else a.setFocus(!0),this._currentTapID=a.id}}else{-1!=this._currentTapID&&(this._currentTapID=-1);var i=new ElementViewManageEvent(ElementViewManageEvent.USE_PROP_CLICK);i.propToElementLocation=e.currentTarget.location,GameLogic.instance.pvm.useProp(null),this.dispatchEvent(i)}},i.setNewElementFocus=function(e){this.elementviews[this._currentTapID].setFocus(!1),this.elementviews[e].setFocus(!0),this._currentTapID=e},i.touchStart=function(e){if(this.canTouch){SoundManager.playEffect("Clock Tick_wav");var a=e.currentTarget;this._currentMoveID=a.id;for(var t=GameData.MaxColumn*GameData.MaxRow,i=0;t>i;i++)this.elementviews[i].addEventListener(egret.TouchEvent.TOUCH_MOVE,this.touchMove,this)}},i.touchMove=function(e){var a=e.currentTarget;if(a.id!=this._currentMoveID){var t=new ElementViewManageEvent(ElementViewManageEvent.TAP_TWO_ELEMENT);t.ele1=this._currentMoveID,t.ele2=a.id;for(var i=GameData.MaxColumn*GameData.MaxRow,n=0;i>n;n++)this.elementviews[n].removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.touchMove,this);this.dispatchEvent(t)}},i.changeLocationAndBack=function(e,a){this.elementviews[e].focus?(this.elementviews[e].setFocus(!1),this._layer.getChildIndex(this.elementviews[e])<this._layer.getChildIndex(this.elementviews[a])&&this._layer.swapChildren(this.elementviews[e],this.elementviews[a]),this.elementviews[e].moveAndBack(this.elementviews[a].location,!0),this.elementviews[a].moveAndBack(this.elementviews[e].location)):(this.elementviews[a].setFocus(!1),this._layer.getChildIndex(this.elementviews[e])<this._layer.getChildIndex(this.elementviews[a])&&this._layer.swapChildren(this.elementviews[e],this.elementviews[a]),this.elementviews[e].moveAndBack(this.elementviews[a].location),this.elementviews[a].moveAndBack(this.elementviews[e].location,!0)),this._currentTapID=-1},i.changeLocationAndScale=function(e,a){var t=this.elementviews[e].location,i=this.elementviews[a].location;this.elementviews[e].focus?(this.elementviews[e].setFocus(!1),this._layer.getChildIndex(this.elementviews[e])<this._layer.getChildIndex(this.elementviews[a])&&this._layer.swapChildren(this.elementviews[e],this.elementviews[a]),this.elementviews[e].moveAndScale(i,!0),this.elementviews[a].moveAndScale(t)):(this.elementviews[a].setFocus(!1),this._layer.getChildIndex(this.elementviews[e])<this._layer.getChildIndex(this.elementviews[a])&&this._layer.swapChildren(this.elementviews[e],this.elementviews[a]),this.elementviews[e].moveAndScale(i),this.elementviews[a].moveAndScale(t,!0)),this._currentTapID=-1},i.showAllElement=function(){this._layer.removeChildren();for(var e,a=(GameData.stageW-40)/GameData.MaxColumn,t=GameData.stageH-(GameData.stageW-30)/6-60-a*GameData.MaxColumn,i=0;i<GameData.MaxRow;i++)for(var n=0;n<GameData.MaxColumn;n++)-1!=GameData.mapData[i][n]&&(e=this.elementviews[GameData.mapData[i][n]],e.setTexture("e"+GameData.elements[GameData.mapData[i][n]].type+"_png"),e.x=e.targetX(),e.y=t-e.width,e.show(1200-300*i));this.specialAni()},i.specialAni=function(){for(var e=0;e<this.elementviews.length;e++)0!=this.elementviews[e].special&&this.elementviews[e].playSpecial();egret.setTimeout(function(){this.specialAni()},this,1400)},i.removeAniOver=function(e){this.removenum++,2==this.removenum&&(this.removenum=0,this.dispatchEvent(e))},i.playReqRemoveAn=function(e,a,t){this.moveeleNum++;var i=this.elementviews[e];i.parent&&this._layer.setChildIndex(i,this._layer.numChildren),i.playCurveMove(a,t)},i.playRemoveAni=function(e){this.moveeleNum++;var a=this.elementviews[e];if(a.parent&&this._layer.setChildIndex(a,this._layer.numChildren),a.playRemoveAni(),GameLogic.instance.energyNum<100){var t=new egret.Bitmap;t.texture=RES.getRes("energy_png"),t.width=t.width/2,t.height=t.height/2,t.alpha=.7,this._layer.addChild(t),t.x=this.elementviews[e].targetX()-10,t.y=this.elementviews[e].targetY()-20;var i=egret.Tween.get(t);i.to({x:GameData.stageW/2,y:20,alpha:.3},1e3,egret.Ease.cubicInOut);egret.setTimeout(function(){this._layer.removeChild(t)},this,1e3)}},i.updateMap=function(e){this.moveeleNum--,0==this.moveeleNum&&this.dispatchEvent(e)},i.updateMapData=function(){var e=this.elementviews.length;this.movelocElementNum=0;for(var a=0;e>a;a++){this.elementviews[a].location=GameData.elements[a].location,GameData.elements[a].is=!1;var t=this.elementviews[a];switch(GameData.elements[a].special){case 0:t.setTexture("e"+GameData.elements[a].type+"_png");break;case 1:t.setTexture("s1e"+GameData.elements[a].type+"_png"),t.special=1;break;case 2:t.setTexture("s2e"+GameData.elements[a].type+"_png"),t.special=2;break;case 3:t.setTexture("s3e"+GameData.elements[a].type+"_png"),t.special=3;break;case 4:t.setTexture("allColor_png"),t.special=4}this.elementviews[a].moveNewLocation()}},i.moveNewLocationOver=function(e){if(this.movelocElementNum++,this.movelocElementNum==GameData.MaxColumn*GameData.MaxRow){var a=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_VIEW_OVER);this.dispatchEvent(a)}},a}(egret.EventDispatcher);egret.registerClass(ElementViewManage,"ElementViewManage");var EnemyManage=function(e){function a(a){e.call(this),this.enemyNum=0,this._layer=a,this.init()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.init=function(){this.enemyviews=new Array;var e=GameLogic.instance.level,a=RES.getRes("l"+e+"_json");this.enemyNum=a.enemyNum,this.startP=a.map[0],this.enemyType=a.enemyType,this.startNum=a.startNum;egret.setTimeout(function(){this.gameStart()},this,1400)},i.gameStart=function(){if(this.nextStep(!1),this.startNum--,this.startNum>0){egret.setTimeout(function(){this.gameStart()},this,200)}else{var e=GameLogic.instance.level,a=RES.getRes("l"+e+"_json");if(1==a.color)for(var t,i=a.enemyType.toString(),n=!0,s=a.startNum,m=0;s>m;m++){for(n=!0;n;)t=Math.floor(Math.random()*GameData.elementTypes.length),t!=this.lastType&&(this.enemyviews[m].type=t.toString(),GameData.enemys[this.enemyviews[m].location].type=this.enemyviews[m].type,n=LinkLogic.isHaveLine());this.enemyviews[m].setTexture("e"+i+t+"_png"),this.lastType=t}}},i.createEnemy=function(e){void 0===e&&(e=!1);var a=new EnemyView(this._layer);this.enemyviews.push(a);var t,i=GameLogic.instance.level,n=RES.getRes("l"+i+"_json"),s=n.enemyType.toString();if(0==n.color||0==e)t=9;else for(var m=!0;m;)t=Math.floor(Math.random()*GameData.elementTypes.length),t!=this.lastType&&(m=!1);this.lastType=t,a.enemyType=s,a.type=t.toString(),a.hp=n.hp,a.hpShow(a.hp),a.setTexture("e"+s+t+"_png"),a.location=this.startP,GameData.enemys[a.location].type=a.type,this._layer.addChild(a);var r=egret.Tween.get(a);r.to({x:a.targetX(),y:a.targetY()},0,egret.Ease.bounceInOut),GameLogic.instance.checkOtherElementLink(null)},i.nextStep=function(e){if(void 0===e&&(e=!0),this.enemyviews.length>0)for(var a=0;a<this.enemyviews.length;a++)this.enemyviews[a].hp>0&&this.enemyviews[a].move();this.enemyNum>0&&(this.createEnemy(e),this.enemyNum--)},a}(egret.EventDispatcher);egret.registerClass(EnemyManage,"EnemyManage");var EnemyView=function(e){function a(a){e.call(this),this.type="",this.hp=0,this.location=0,this.enemyType="",this.road=[],this.hpText=new egret.TextField,this.init()}__extends(a,e);var t=(__define,a),i=t.prototype;return i.init=function(){this.touchEnabled=!0,this.touchChildren=!1,this.bitmap=new egret.Bitmap;var e=(GameData.stageW-40)/GameData.MaxColumn;this.bitmap.width=this.bitmap.height=e,this.bitmap.x=-1*e/2,this.bitmap.y=-1*e/2,this.addChild(this.bitmap);var a=GameLogic.instance.level,t=RES.getRes("l"+a+"_json");this.road=t.map,this.hpText.text="",this.hpText.x=.2*e,this.hpText.y=.2*e,this.hpText.size=18,this.hpText.textColor=0,this.addChild(this.hpText)},i.setTexture=function(e){this.bitmap.texture=RES.getRes(e)},i.targetX=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=8+e*(this.location%GameData.MaxColumn)+e/2+5+2*(this.location%GameData.MaxColumn);return a},i.targetY=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=GameData.stageH-(GameData.stageW-30)/6-60-e*GameData.MaxColumn-5,t=a+e*Math.floor(this.location/GameData.MaxColumn)+e/2+5+2*Math.floor(this.location/GameData.MaxColumn);return t},i.move=function(){GameData.enemys[this.location].type="";for(var e=0;e<this.road.length;e++)if(this.location==this.road[e]){if(e!=this.road.length-1){this.location=this.road[e+1],GameData.enemys[this.location].type=this.type;var a=egret.Tween.get(this);a.to({x:this.targetX(),y:this.targetY()},300,egret.Ease.bounceInOut);break}this.hp=0,this.clean(),GameData.gameLife--,GameLogic.instance.gameUI.lifeChange(),GameLogic.instance.checkOtherElementLink(null)}},i.injured=function(){this.hp--;var e=egret.Tween.get(this);this.injuredAni(),e.wait(300,!1),this.hp>0?(GameData.gameScore+=10,this.hpShow(this.hp)):(GameData.gameScore+=30,GameData.enemys[this.location].type="",this.clean()),GameLogic.instance.gameUI.update()},i.injuredAni=function(){var e=egret.Tween.get(this);e.to({alpha:.5},150,egret.Ease.cubicInOut).to({alpha:.8},150,egret.Ease.cubicInOut).to({alpha:.5},150,egret.Ease.cubicInOut).to({alpha:1},50,egret.Ease.cubicInOut)},i.clean=function(){GameData.enemyDeath++,this.parent.removeChild(this)},i.hpShow=function(e){e>3&&(this.hp=e=3),this.hpText.text=e.toString()},a}(egret.Sprite);egret.registerClass(EnemyView,"EnemyView");var GameBackground=function(e){function a(){e.call(this)}__extends(a,e);var t=(__define,a),i=t.prototype;return i.changeBackground=function(){this.cacheAsBitmap=!1,this.removeChildren(),this.createBackgroundImage(),this.createMapBg(),this.createLevelReqBg(),this.cacheAsBitmap=!0},i.createBackgroundImage=function(){this.bgImage||(this.bgImage=new egret.Bitmap),this.bgImage.texture=RES.getRes(GameData.levelBackgroundImageName),this.addChild(this.bgImage);var e=new egret.Bitmap;e.texture=RES.getRes(""),e.y=GameData.stageH-e.height,this.addChild(e)},i.createMapBg=function(){this.girdBg||(this.girdBg=new Array);for(var e,a=(GameData.stageW-40)/GameData.MaxColumn,t=GameData.stageH-(GameData.stageW-30)/6-60-a*GameData.MaxColumn,i=0;i<GameData.MaxRow;i++)for(var n=0;n<GameData.MaxColumn;n++){if(this.girdBg.length<=i*GameData.MaxRow+n?(e=new egret.Bitmap,this.girdBg.push(e)):e=this.girdBg[i*GameData.MaxRow+n],-1!=GameData.mapData[i][n])e.texture=RES.getRes("grid_png");else{var s=RES.getRes("l1_json");i*GameData.MaxColumn+n==s.map[s.map.length-1]?e.texture=RES.getRes("life_png"):e.texture=RES.getRes("road_png")}e.width=e.height=a,e.x=13+a*n+2*n,e.y=t+a*i+2*i,this.addChild(e)}},i.createLevelReqBg=function(){var e=((GameData.stageW-40)/GameData.MaxColumn,new egret.Bitmap);e.texture=RES.getRes(""),e.x=20,e.y=50,this.addChild(e);var a=new egret.Bitmap;a.texture=RES.getRes(""),a.x=e.x+(e.width-a.width)/2,a.y=e.y-18,this.addChild(a)},a}(egret.Sprite);egret.registerClass(GameBackground,"GameBackground");var GameLogic=function(){function e(a){this.level=1,this.isfreeze=0,this.energyNum=0,this._gameStage=a,this.main(),e.instance=this,SoundManager.playBgSound("bgm_mp3")}var a=(__define,e),t=a.prototype;return t.main=function(){this.startUI=new startUI,this._gameStage.addChild(this.startUI)},t.init=function(){GameData.initData();var e=RES.getRes("l"+this.level+"_json");MapDataPares.createMapData(e.map),LevelGameDataParse.parseLevelGameData(e),GameData.gameLife=e.life,GameData.enemynum=e.enemyNum,GameData.enemyDeath=0,this.mapc=new MapControl,this.mapc.createElementAllMap();var a=new GameBackground;this._gameStage.addChild(a),a.changeBackground();var t=new egret.Sprite;this._gameStage.addChild(t),this.evm=new ElementViewManage(t),this.evm.showAllElement(),this.evm.addEventListener(ElementViewManageEvent.TAP_TWO_ELEMENT,this.viewTouchTap,this),this.evm.addEventListener(ElementViewManageEvent.REMOVE_ANIMATION_OVER,this.removeAniOver,this),this.evm.addEventListener(ElementViewManageEvent.UPDATE_MAP,this.createNewElement,this),this.evm.addEventListener(ElementViewManageEvent.UPDATE_VIEW_OVER,this.checkOtherElementLink,this),this.evm.addEventListener(ElementViewManageEvent.USE_PROP_CLICK,this.usePropClick,this);var i=new egret.Sprite;this._gameStage.addChild(i),this.em=new EnemyManage(i);var n=new egret.Sprite;this._gameStage.addChild(n),this.gameUI=new game,n.addChild(this.gameUI);var s=new egret.Sprite;this._gameStage.addChild(s),this.pvm=new PropViewManage(s)},t.viewTouchTap=function(e){var a=LinkLogic.canMove(e.ele1,e.ele2);if(a){var t=LinkLogic.isHaveLineByIndex(GameData.elements[e.ele1].location,GameData.elements[e.ele2].location);t?(GameData.elements[e.ele1].is=!0,GameData.elements[e.ele2].is=!0,this.evm.canTouch=!1,this.evm.changeLocationAndScale(e.ele1,e.ele2)):(this.evm.changeLocationAndBack(e.ele1,e.ele2),SoundManager.playEffect("Wrong Move_mp3"))}else this.evm.setNewElementFocus(e.ele2)},t.removeAniOver=function(e){for(var a=LinkLogic.lines.length,t=0;a>t;t++)for(var i="",n=LinkLogic.lines[t].length,s=0;n>s;s++)-1!=LinkLogic.lines[t][s]&&(i=GameData.elements[LinkLogic.lines[t][s]].type,this.evm.playRemoveAni(LinkLogic.lines[t][s]))},t.createNewElement=function(e){SoundManager.playEffect("Whop_mp3"),this.mapc.updateMapLovation(),this.evm.updateMapData()},t.checkOtherElementLink=function(e){if(LinkLogic.isHaveLine())this.removeAniOver(null);else if(LinkLogic.isNextHaveLine())this.evm.canTouch||(this.evm.canTouch=!0,this.isfreeze>0?this.isfreeze--:this.em.nextStep());else{for(var a=!1,t=!0;t;)LinkLogic.chageOrder(),LinkLogic.isHaveLine()||LinkLogic.isNextHaveLine()&&(t=!1,a=!0);a&&(console.log("乱序操作"),this.evm.updateMapData())}this.isGameOver()},t.isGameOver=function(){GameData.enemyDeath==GameData.enemynum&&this.gameOver(!0),GameData.gameLife<=0&&this.gameOver(!1)},t.gameOver=function(e){this.evm=null,this.mapc=null,this.pvm=null,this.em=null,GameData.elements=[],GameData.elementTypes=[],GameData.mapData=[],GameData.arguments=[],GameData.currentElementNum=0,GameData.gameLife=0,GameData.unusedElements=[],this.isfreeze=0,this._gameStage.removeChildren();egret.Tween.get(this);egret.Tween.removeAllTweens(),e?this.level<11?(this.level++,this.init()):(this.level=1,this.init()):this.init()},t.winer=function(){},t.usePropClick=function(e){PropLogic.useProp(PropViewManage.proptype,e.propToElementLocation),this.removeAniOver(null)},e}();egret.registerClass(GameLogic,"GameLogic");var GameOverPanel=function(e){function a(){e.call(this),this._issuccess=!1}__extends(a,e);var t=(__define,a),i=t.prototype;return i.show=function(e){this._issuccess=e,this._view=new egret.Bitmap,this._view.texture=RES.getRes(""),this._view.x=this._view.width/-2,this._view.y=this._view.height/-2,this.addChild(this._view),this.x=GameData.stageW/2,this.y=GameData.stageH/2,this.scaleX=.1,this.scaleY=.1,egret.Tween.get(this).to({scaleX:1,scaleY:1},700,egret.Ease.bounceOut).call(this.playStarAni,this)},i.playStarAni=function(){var e=new egret.Bitmap;if(e.texture=RES.getRes(""),e.x=this._view.x+(this._view.width-e.width)/2,e.y=this._view.y-10,e.scaleX=0,e.scaleY=0,this.addChild(e),egret.Tween.get(e).to({scaleX:1,scaleY:1},700,egret.Ease.bounceOut),this._issuccess){var a=new egret.Bitmap;a.texture=RES.getRes(""),a.x=this._view.x+(GameData.stageW-2*a.width)/3,a.y=this._view.y+150,a.scaleX=1.5,a.scaleY=1.5,a.alpha=0,this.addChild(a),egret.Tween.get(a).to({scaleX:1,scaleY:1,alpha:1},700,egret.Ease.circIn)}},a}(egret.Sprite);egret.registerClass(GameOverPanel,"GameOverPanel");var LevelElementView=function(e){function a(){e.call(this),this.eltype="",this.init()}__extends(a,e);var t=__define,i=a,n=i.prototype;return t(n,"num",function(){return Number(this.bittext.text)},function(e){0>=e?this.checkmarkbit||(this.checkmarkbit=new egret.Bitmap,this.checkmarkbit.texture=RES.getRes(""),this.checkmarkbit.x=(this.bitmap.width-this.checkmarkbit.width)/2,this.checkmarkbit.y=this.bitmap.height+this.bitmap.y-this.checkmarkbit.height/2,this.addChild(this.checkmarkbit),this.removeChild(this.bittext)):this.bittext.text=e.toString()}),n.init=function(){this.touchChildren=!1,this.bitmap||(this.bitmap=new egret.Bitmap);var e=(GameData.stageW-40)/GameData.MaxColumn;this.addChild(this.bitmap),this.bittext=new egret.BitmapText,this.bittext.font=RES.getRes(""),this.bittext.text="",this.bittext.x=(e-this.bittext.width)/2,this.bittext.y=this.bitmap.height+this.bitmap.y-this.bittext.height/2,this.addChild(this.bittext)},n.setTexture=function(e){this.bitmap.texture=RES.getRes(e)},a}(egret.Sprite);egret.registerClass(LevelElementView,"LevelElementView");var LevelReqViewManage=function(){function e(e){this._layer=e,this.init()}var a=(__define,e),t=a.prototype;return t.init=function(){this.elements=new Array},t.createCurrentLevelReq=function(){for(var e,a=GameData.levelreq.getLevelReqNum(),t=0;a>t;t++)this.elements.length<=t?(e=new LevelElementView,this.elements.push(e)):e=this.elements[t],e.eltype=GameData.levelreq.reqElements[t].type,e.setTexture("e"+e.eltype+"_png"),e.x=43+1*(5+e.width),e.y=95,e.num=GameData.levelreq.reqElements[t].num,this._layer.addChild(e);this.stepNumText||(this.stepNumText=new egret.TextField,this.stepNumText.x=GameData.stageW-95,this.stepNumText.y=90,this.stepNumText.scaleX=1.5,this.stepNumText.scaleY=1.5,this._layer.addChild(this.stepNumText))},t.haveReqType=function(e){for(var a=this.elements.length,t=0;a>t;t++)if(this.elements[t].eltype==e)return!0;return!1},t.getPointByType=function(e){for(var a=new egret.Point,t=this.elements.length,i=0;t>i;i++)this.elements[i].eltype==e&&(a.x=this.elements[i].x+this.elements[i].width/2,a.y=this.elements[i].y+this.elements[i].height/2);return a},t.update=function(){for(var e=GameData.levelreq.getLevelReqNum(),a=0;e>a;a++)this.elements[a].num=GameData.levelreq.reqElements[a].num},t.updateStep=function(){},e}();egret.registerClass(LevelReqViewManage,"LevelReqViewManage");var PropView=function(e){function a(a){e.call(this),this._numText=new egret.TextField,this._type=-1,this.id=-1,this._num=0,this.focus=!1,this._type=a,this.init()}__extends(a,e);var t=__define,i=a,n=i.prototype;return t(n,"proptype",function(){return this._type}),n.init=function(){this.createView(),this.creatNumText(),this.addChild(this._view_box),this.addChild(this._view_activate),this.addChild(this._numText)},n.creatNumText=function(){this._numText.x=this._view_activate.width-31,this._numText.textColor=0,this._numText.y=this._view_activate.width-25},n.createView=function(){var e=20,a=(GameData.stageW-6*e)/5;this._view_activate||(this._view_activate=new egret.Bitmap,this._view_activate.texture=RES.getRes(this.getActivateTexture(this._type)),this._view_activate.width=this._view_activate.height=a,this._view_activate.x=-5,this._view_activate.y=-5),this._view_box||(this._view_box=new egret.Bitmap,this._view_box.texture=RES.getRes("yuan2_png"),this._view_box.width=this._view_box.height=a,this._view_box.x=-5,this._view_box.y=-5)},t(n,"num",function(){return this._num},function(e){this._num=e,this._numText.text=e.toString(),0>=e?this.setActivateState(!1):this.setActivateState(!0)}),n.setActivateState=function(e){if(this.touchEnabled=e,e){var a=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],t=new egret.ColorMatrixFilter(a);this._view_activate.filters=[t],this._view_box.texture=RES.getRes("yuan2_png")}else{var a=[.3,.6,0,0,0,.3,.6,0,0,0,.3,.6,0,0,0,0,0,0,1,0],t=new egret.ColorMatrixFilter(a);this._view_activate.filters=[t],this._view_box.texture=RES.getRes("yuan2_png")}},n.getActivateTexture=function(e){var a="";switch(e){case 0:a="prop1_png";break;case 1:a="prop2_png";break;case 2:a="prop3_png";break;case 3:a="prop4_png";break;case 4:a="prop5_png"}return a},n.setFocus=function(e){e?(this.focus=!0,this._view_box.texture=RES.getRes("yuan2_png")):(this.focus=!1,this._view_box.texture=RES.getRes("yuan2_png"))},a}(egret.Sprite);egret.registerClass(PropView,"PropView");var PropViewManage=function(){function e(e){this.energy=new egret.TextField,this.randomProp=new PropView(0),this._currentID=-1,this._layer=e,this.init()}var a=(__define,e),t=a.prototype;return t.init=function(){this._props=new Array,this.createData(),this.setEnergy(),this.energy.x=GameData.stageW/2-25,this.energy.y=53,this.energy.size=45,this.energy.textColor=0,this._layer.addChild(this.energy),this.randomProp.x=GameData.stageW/2-50,this.randomProp.y=20;var e=(GameData.stageW-120)/3-5;this.randomProp._view_activate.width=this.randomProp._view_activate.height=e,this.randomProp._view_box.alpha=0,this.randomProp._view_activate.alpha=0,this.randomProp._numText.alpha=0,this.randomProp.addEventListener(egret.TouchEvent.TOUCH_TAP,this.click,this),this.randomProp.num=100,this._layer.addChild(this.randomProp)},t.createData=function(){for(var e=0;5>e;e++){var a=new PropView(e);a.x=15+(5+a.width)*e,a.y=GameData.stageH-a.height,this._layer.addChild(a),this._props.push(a),4==e?a.num=0:a.num=1,a.id=e,a.addEventListener(egret.TouchEvent.TOUCH_TAP,this.click,this)}},t.click=function(a){if(SoundManager.playEffect("Clock Tick_wav"),2==a.currentTarget.id)return this._currentID=a.currentTarget.id,LinkLogic.chageOrder(),GameLogic.instance.evm.updateMapData(),void this.useProp(a.currentTarget);if(3==a.currentTarget.id)return this._currentID=a.currentTarget.id,GameLogic.instance.isfreeze+=2,void this.useProp(a.currentTarget);if(-1!=this._currentID){if(a.currentTarget==this.randomProp)return console.log(a.currentTarget.id),void(this.randomProp.focus?(this._currentID=-1,e.proptype=-1):(this.randomProp.setFocus(!0),this._currentID=this.randomProp.id,e.proptype=this.randomProp.proptype));this._props[this._currentID].setFocus(!1),this._currentID==a.currentTarget.id?(this._currentID=-1,e.proptype=-1):(this._currentID=a.currentTarget.id,this._props[this._currentID].setFocus(!0),e.proptype=this._props[this._currentID].proptype)}else this._currentID=a.currentTarget.id,this._props[this._currentID].setFocus(!0),e.proptype=this._props[this._currentID].proptype},t.creatRandomProp=function(){var e=RandomUtils.limit(1,4);this.randomProp.id=e-1,this.randomProp._type=e-1,this.randomProp._view_activate.texture=RES.getRes("prop"+e+"_png"),this.randomProp._view_activate.alpha=1,GameLogic.instance.energyNum=0,this.energy.alpha=0},t.checkRandomProp=function(){return 1==this.randomProp._view_activate.alpha?void(GameLogic.instance.energyNum=0):(this.setEnergy(),void(GameLogic.instance.energyNum>99&&this.creatRandomProp()))},t.setEnergy=function(){GameLogic.instance.energyNum>10?this.energy.text=GameLogic.instance.energyNum.toString():this.energy.text=" "+GameLogic.instance.energyNum.toString()},t.useProp=function(a){return a==this.randomProp||this.randomProp.focus?(this.randomProp._view_activate.alpha=0,this.energy.alpha=1,this.setEnergy(),void this.randomProp.setFocus(!1)):(this._props[this._currentID].num--,this._props[this._currentID].setFocus(!1),this._currentID=-1,void(e.proptype=-1))},e.proptype=-1,e}();egret.registerClass(PropViewManage,"PropViewManage");